<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>D3 â†’ C/H/M/R ì—´ ì—…ë¡œë“œ ë„êµ¬</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <!-- Google Identity Services (OAuth í† í°ìš©) -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <!-- XLSX íŒŒì„œ (ë¸Œë¼ìš°ì €ì—ì„œ .xlsx ì½ê¸°ìš©) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    :root {
      --bg: #f8fafc;
      --card: #ffffff;
      --border: #e5e7eb;
      --accent: #2563eb;
      --accent-soft: #dbeafe;
      --danger: #ef4444;
      --ok: #22c55e;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background: var(--bg);
      color: #0f172a;
    }
    .app {
      max-width: 960px;
      margin: 0 auto;
      padding: 16px;
    }
    header {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 16px;
    }
    header h1 {
      font-size: 1.25rem;
      margin: 0;
    }
    .sub {
      font-size: 0.85rem;
      color: #64748b;
    }
    button {
      cursor: pointer;
      border-radius: 999px;
      border: 1px solid transparent;
      padding: 8px 16px;
      font-size: 0.9rem;
      font-weight: 500;
      background: var(--accent);
      color: white;
      transition: background 0.15s ease, transform 0.05s ease;
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    button:hover:not(:disabled) {
      background: #1d4ed8;
      transform: translateY(-1px);
    }
    .panel {
      background: var(--card);
      border-radius: 12px;
      border: 1px solid var(--border);
      padding: 16px 16px 12px;
      margin-bottom: 12px;
    }
    .panel h2 {
      font-size: 1rem;
      margin: 0 0 4px;
    }
    .panel small {
      font-size: 0.8rem;
      color: #64748b;
    }
    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 8px;
      align-items: center;
    }
    input[type="file"] {
      font-size: 0.85rem;
    }
    .status {
      font-size: 0.8rem;
      margin-top: 6px;
      min-height: 1.1em;
    }
    .status.ok { color: var(--ok); }
    .status.err { color: var(--danger); }
    .status.info { color: #64748b; }
    .auth-status {
      font-size: 0.85rem;
    }
    .auth-status span {
      font-weight: 600;
    }
    .pill {
      display: inline-flex;
      padding: 4px 8px;
      border-radius: 999px;
      font-size: 0.78rem;
      background: #fee2e2;
      color: #b91c1c;
      margin-top: 4px;
    }
    @media (max-width: 600px) {
      header { align-items: flex-start; }
      .row { flex-direction: column; align-items: flex-start; }
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div>
        <h1>.xlsx D3 â†’ C/H/M/R ì—´ ì—…ë¡œë“œ</h1>
        <div class="sub">
          ê° ì—‘ì…€ íŒŒì¼ì˜ <strong>D3</strong> ì…€ ê°’ì„ ì½ì–´ì„œ, ì§€ì •í•œ ì—´(C/H/M/R)ì˜
          <strong>2í–‰ë¶€í„°</strong> ì•„ë˜ë¡œ ì°¨ë¡€ëŒ€ë¡œ ì¶”ê°€í•©ë‹ˆë‹¤.<br/>
          ğŸ‘‰ ë‹¤ë¥¸ ì—´/í–‰ì€ ê±´ë“œë¦¬ì§€ ì•Šê³ , í•´ë‹¹ ì—´ ì…€ë§Œ ì±„ì›ë‹ˆë‹¤.
        </div>
      </div>
      <div style="text-align:right;">
        <button id="auth-btn" type="button">Google ë¡œê·¸ì¸í•˜ê¸°</button>
        <div id="auth-status" class="auth-status">
          <span>ë¡œê·¸ì¸ í•„ìš”</span> Â· ìŠ¤í”„ë ˆë“œì‹œíŠ¸ í¸ì§‘ ê¶Œí•œ í—ˆìš©
        </div>
      </div>
    </header>

    <div class="panel">
      <div class="pill">ì£¼ì˜: ì´ í˜ì´ì§€ëŠ” https://(ë„ë©”ì¸)/ í˜•íƒœë¡œ í˜¸ìŠ¤íŒ…ë˜ì–´ì•¼ í•©ë‹ˆë‹¤. file:// ë¡œëŠ” OAuthê°€ ì•ˆ ë©ë‹ˆë‹¤.</div>
    </div>

    <!-- C ì—´ ì—…ë¡œë“œ -->
    <section class="panel">
      <h2>Cì—´ì— ë„£ì„ íŒŒì¼(.xlsx)</h2>
      <small>ì²« ë²ˆì§¸ ì‹œíŠ¸ì˜ D3 ì…€ â†’ ì—°ê²°ëœ ì‹œíŠ¸ì˜ Cì—´ (í—¤ë” 1í–‰ ì œì™¸, 2í–‰ë¶€í„°)</small>
      <div class="row">
        <input type="file" id="file-c" multiple accept=".xlsx" />
        <button type="button" id="btn-c" onclick="uploadColumn('C')" disabled>Cì—´ ì—…ë¡œë“œ</button>
      </div>
      <div id="status-C" class="status info"></div>
    </section>

    <!-- H ì—´ ì—…ë¡œë“œ -->
    <section class="panel">
      <h2>Hì—´ì— ë„£ì„ íŒŒì¼(.xlsx)</h2>
      <small>ì²« ë²ˆì§¸ ì‹œíŠ¸ì˜ D3 ì…€ â†’ ì—°ê²°ëœ ì‹œíŠ¸ì˜ Hì—´</small>
      <div class="row">
        <input type="file" id="file-h" multiple accept=".xlsx" />
        <button type="button" id="btn-h" onclick="uploadColumn('H')" disabled>Hì—´ ì—…ë¡œë“œ</button>
      </div>
      <div id="status-H" class="status info"></div>
    </section>

    <!-- M ì—´ ì—…ë¡œë“œ -->
    <section class="panel">
      <h2>Mì—´ì— ë„£ì„ íŒŒì¼(.xlsx)</h2>
      <small>ì²« ë²ˆì§¸ ì‹œíŠ¸ì˜ D3 ì…€ â†’ ì—°ê²°ëœ ì‹œíŠ¸ì˜ Mì—´</small>
      <div class="row">
        <input type="file" id="file-m" multiple accept=".xlsx" />
        <button type="button" id="btn-m" onclick="uploadColumn('M')" disabled>Mì—´ ì—…ë¡œë“œ</button>
      </div>
      <div id="status-M" class="status info"></div>
    </section>

    <!-- R ì—´ ì—…ë¡œë“œ -->
    <section class="panel">
      <h2>Rì—´ì— ë„£ì„ íŒŒì¼(.xlsx)</h2>
      <small>ì²« ë²ˆì§¸ ì‹œíŠ¸ì˜ D3 ì…€ â†’ ì—°ê²°ëœ ì‹œíŠ¸ì˜ Rì—´</small>
      <div class="row">
        <input type="file" id="file-r" multiple accept=".xlsx" />
        <button type="button" id="btn-r" onclick="uploadColumn('R')" disabled>Rì—´ ì—…ë¡œë“œ</button>
      </div>
      <div id="status-R" class="status info"></div>
    </section>
  </div>

  <script>
    // === 1. ì„¤ì •ê°’ (ì—¬ê¸°ë§Œ ë³¸ì¸ ê±¸ë¡œ êµì²´) ==========================
    const CLIENT_ID = '18228268359-iifm4ck3j9kqj74eh1p90tco1k2mbpi0.apps.googleusercontent.com'; // TODO: ë³¸ì¸ OAuth í´ë¼ì´ì–¸íŠ¸ ID
    const SPREADSHEET_ID = '1APS4O3FRFKVf7nAxkjuVV1JhoA5Rm3mW9pyz6Vkq8NQ'; // TODO: ê°’ ë„£ì„ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ID
    const SHEET_NAME = 'ì‹œíŠ¸1';                                          // TODO

    // ë²„íŠ¼(C/H/M/R) â†’ ì‹¤ì œ ì‹œíŠ¸ ì—´ ë¬¸ì ë§¤í•‘
    const TARGET_COLUMNS = {
      C: 'C',
      H: 'H',
      M: 'M',
      R: 'R',
    };

    // ===============================================================
    let tokenClient;
    let accessToken = null;

    // ì—´ë³„ë¡œ ì„ íƒëœ íŒŒì¼ ëˆ„ì  ì €ì¥ìš©
    const selectedFiles = { C: [], H: [], M: [], R: [] };

    function setAuthUI(authed) {
      const authBtn = document.getElementById('auth-btn');
      const authStatus = document.getElementById('auth-status');
      const buttons = ['btn-c','btn-h','btn-m','btn-r'].map(id => document.getElementById(id));

      if (authed) {
        authBtn.textContent = 'ë‹¤ì‹œ ê¶Œí•œ í™•ì¸í•˜ê¸°';
        authStatus.innerHTML = '<span>ë¡œê·¸ì¸ ì™„ë£Œ</span> Â· ì—…ë¡œë“œ ê°€ëŠ¥';
        buttons.forEach(b => b.disabled = false);
      } else {
        authBtn.textContent = 'Google ë¡œê·¸ì¸í•˜ê¸°';
        authStatus.innerHTML = '<span>ë¡œê·¸ì¸ í•„ìš”</span> Â· ìŠ¤í”„ë ˆë“œì‹œíŠ¸ í¸ì§‘ ê¶Œí•œ í—ˆìš©';
        buttons.forEach(b => b.disabled = true);
      }
    }

    window.addEventListener('load', () => {
      // Google OAuth í† í° í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™”
      tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: 'https://www.googleapis.com/auth/spreadsheets',
        callback: (tokenResponse) => {
          accessToken = tokenResponse.access_token;
          setAuthUI(true);
        },
      });

      document.getElementById('auth-btn').addEventListener('click', () => {
        tokenClient.requestAccessToken({ prompt: accessToken ? '' : 'consent' });
      });

      // íŒŒì¼ ì„ íƒ ì‹œ ì—´ë³„ íŒŒì¼ ëˆ„ì 
      ['C','H','M','R'].forEach(col => {
        const lower = col.toLowerCase();
        const input = document.getElementById('file-' + lower);
        const statusEl = document.getElementById('status-' + col);

        input.addEventListener('change', (e) => {
          const files = Array.from(e.target.files || []);
          if (!files.length) return;

          const store = selectedFiles[col];

          files.forEach(f => {
            const exists = store.some(
              x => x.name === f.name && x.size === f.size && x.lastModified === f.lastModified
            );
            if (!exists) store.push(f);
          });

          statusEl.className = 'status info';
          statusEl.textContent =
            `í˜„ì¬ ì„ íƒëœ íŒŒì¼ ${store.length}ê°œ: ` + store.map(f => f.name).join(', ');

          // ê°™ì€ íŒŒì¼ ë‹¤ì‹œ ì„ íƒ ê°€ëŠ¥í•˜ê²Œ ì´ˆê¸°í™”
          input.value = '';
        });
      });

      setAuthUI(false);
    });

    // === 2. .xlsxì—ì„œ D3 ì½ê¸° =========================================
    function readD3FromFile(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onerror = () => reject(new Error('íŒŒì¼ ì½ê¸° ì‹¤íŒ¨: ' + file.name));
        reader.onload = (e) => {
          try {
            const data = new Uint8Array(e.target.result);
            const wb = XLSX.read(data, { type: 'array' });
            const firstSheetName = wb.SheetNames[0];
            const sheet = wb.Sheets[firstSheetName];
            const cell = sheet['D3'];
            const value = cell ? String(cell.v) : '';
            resolve(value);
          } catch (err) {
            reject(new Error('ì—‘ì…€ íŒŒì‹± ì‹¤íŒ¨: ' + file.name + ' Â· ' + err.message));
          }
        };
        reader.readAsArrayBuffer(file);
      });
    }

    // === 3. íŠ¹ì • ì—´(C/H/M/R)ì— ì—…ë¡œë“œ (í–‰ ë°€ë¦¼ ì—†ìŒ) ==================
    async function uploadColumn(colLetter) {
      const statusEl = document.getElementById('status-' + colLetter);
      const files = selectedFiles[colLetter] || [];
      const physicalCol = TARGET_COLUMNS[colLetter] || colLetter;

      if (!accessToken) {
        alert('ë¨¼ì € ìƒë‹¨ì˜ "Google ë¡œê·¸ì¸í•˜ê¸°" ë²„íŠ¼ìœ¼ë¡œ ë¡œê·¸ì¸ì„ í•´ì£¼ì„¸ìš”.');
        return;
      }

      if (!files.length) {
        alert(colLetter + 'ì—´ì— ë„£ì„ .xlsx íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
      }

      statusEl.className = 'status info';
      statusEl.textContent = `ì´ ${files.length}ê°œ íŒŒì¼ì—ì„œ D3 ê°’ì„ ì½ëŠ” ì¤‘...`;

      // 1) íŒŒì¼ë§ˆë‹¤ D3 ì½ê¸°
      const values = [];
      let successCount = 0;
      let emptyCount = 0;
      let failCount = 0;

      for (const file of files) {
        try {
          const v = await readD3FromFile(file);
          if (v === '') emptyCount++;
          values.push([v]); // í•´ë‹¹ ì—´ì˜ í•œ ì…€
          successCount++;
        } catch (err) {
          console.error(err);
          failCount++;
        }
      }

      if (!values.length) {
        statusEl.className = 'status err';
        statusEl.textContent = 'ì½ì–´ ì˜¨ ê°’ì´ ì—†ìŠµë‹ˆë‹¤.';
        return;
      }

      try {
        // 2) í˜„ì¬ ê·¸ ì—´ì— ì´ë¯¸ ëª‡ í–‰ê¹Œì§€ ì±„ì›Œì ¸ ìˆëŠ”ì§€ í™•ì¸
        const colRange = `${SHEET_NAME}!${physicalCol}2:${physicalCol}`;
        const getUrl = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${encodeURIComponent(colRange)}`;

        const resGet = await fetch(getUrl, {
          method: 'GET',
          headers: { 'Authorization': `Bearer ${accessToken}` },
        });

        let existingCount = 0;
        if (resGet.ok) {
          const data = await resGet.json();
          existingCount = (data.values || []).length;
        } else if (resGet.status !== 404) {
          // 404ë©´ ê°’ì´ ì—†ëŠ” ì»¬ëŸ¼ìœ¼ë¡œ ì·¨ê¸‰
          const text = await resGet.text();
          console.warn('col get error:', text);
        }

        // C2ë¶€í„° ì´ë¯¸ existingCountê°œê°€ ì±„ì›Œì ¸ ìˆìœ¼ë¯€ë¡œ
        // ë‹¤ìŒ ê°’ì€ 2 + existingCount í–‰ë¶€í„° ë“¤ì–´ê°„ë‹¤ê³  ë³´ë©´ ë¨
        const startRow = 2 + existingCount;
        const endRow = startRow + values.length - 1;
        const updateRange = `${SHEET_NAME}!${physicalCol}${startRow}:${physicalCol}${endRow}`;

        const putUrl = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${encodeURIComponent(updateRange)}?valueInputOption=RAW`;

        // 3) í•´ë‹¹ ì—´ ì…€ì—ë§Œ ê°’ ì—…ë°ì´íŠ¸ (í–‰/ë‹¤ë¥¸ ì—´ì€ ì†ëŒ€ì§€ ì•ŠìŒ)
        const resUpdate = await fetch(putUrl, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${accessToken}`,
            'Content-Type': 'application/json; charset=utf-8',
          },
          body: JSON.stringify({ values }),
        });

        if (!resUpdate.ok) {
          const text = await resUpdate.text();
          throw new Error('Sheets API update ì˜¤ë¥˜: ' + text);
        }

        statusEl.className = 'status ok';
        statusEl.textContent =
          `${colLetter}ì—´ ì—…ë¡œë“œ ì™„ë£Œ Â· ì„±ê³µ ${successCount}ê°œ, D3 ë¹„ì–´ìˆìŒ ${emptyCount}ê°œ, ì‹¤íŒ¨ ${failCount}ê°œ`;

        // ì—…ë¡œë“œ ëë‚˜ë©´ í•´ë‹¹ ì—´ ì„ íƒ íŒŒì¼ ëª©ë¡ ì´ˆê¸°í™”
        selectedFiles[colLetter] = [];
      } catch (err) {
        console.error(err);
        statusEl.className = 'status err';
        statusEl.textContent = 'ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜: ' + err.message;
      }
    }
  </script>
</body>
</html>
