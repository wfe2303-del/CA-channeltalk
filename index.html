<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>엑셀 헤더열(#{강의명}/#{강좌명}/#{쿠폰명}) → C/H/M/R 업로드</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <!-- Google Identity Services (OAuth) -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <!-- XLSX 파서 -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    :root{
      --bg:#f8fafc; --card:#ffffff; --border:#e5e7eb;
      --accent:#2563eb; --accent-soft:#dbeafe;
      --danger:#ef4444; --ok:#22c55e;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:var(--bg);
      color:#0f172a;
    }
    .app{max-width:960px;margin:0 auto;padding:16px}
    header{
      display:flex;flex-wrap:wrap;
      align-items:center;justify-content:space-between;
      gap:8px;margin-bottom:16px;
    }
    header h1{font-size:1.25rem;margin:0}
    .sub{font-size:.85rem;color:#64748b}
    button{
      cursor:pointer;border-radius:999px;border:1px solid transparent;
      padding:8px 16px;font-size:.9rem;font-weight:500;
      background:var(--accent);color:#fff;
      transition:background .15s ease,transform .05s ease;
    }
    button:disabled{opacity:.5;cursor:not-allowed}
    button:hover:not(:disabled){background:#1d4ed8;transform:translateY(-1px);}
    .panel{
      background:var(--card);border-radius:12px;
      border:1px solid var(--border);
      padding:16px 16px 12px;margin-bottom:12px;
    }
    .panel h2{font-size:1rem;margin:0 0 4px}
    .panel small{font-size:.8rem;color:#64748b}
    .row{
      display:flex;flex-wrap:wrap;gap:8px;
      margin-top:8px;align-items:center;
    }
    input[type="file"]{font-size:.85rem}
    .status{
      font-size:.8rem;margin-top:6px;min-height:1.1em;
      white-space:pre-line;
    }
    .status.ok{color:var(--ok)}
    .status.err{color:var(--danger)}
    .status.info{color:#64748b}
    .auth-status{font-size:.85rem}
    .auth-status span{font-weight:600}
    .pill{
      display:inline-flex;padding:4px 8px;
      border-radius:999px;font-size:.78rem;
      background:#fee2e2;color:#b91c1c;margin-top:4px;
    }
    @media(max-width:600px){
      header{align-items:flex-start}
      .row{flex-direction:column;align-items:flex-start}
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div>
        <h1>엑셀 헤더 → C/H/M/R 업로드</h1>
        <div class="sub">
          각 .xlsx 파일의 <strong>첫 시트</strong>에서<br/>
          아무 행이든 상관없이, 셀 값이 <code>#{강의명}</code> 또는 <code>#{강좌명}</code>인 헤더를 찾고,<br/>
          그 <strong>헤더 바로 아래 행</strong>의 같은 열 값을 읽어<br/>
          연결된 구글 시트 <strong>C / H / M / R 열</strong>(헤더 제외, 2행부터)에 순서대로 채웁니다.
        </div>
      </div>
      <div style="text-align:right;">
        <button id="auth-btn" type="button">Google 로그인하기</button>
        <div id="auth-status" class="auth-status">
          <span>로그인 필요</span> · 스프레드시트 편집 권한 허용
        </div>
      </div>
    </header>

    <div class="panel">
      <div class="pill">
        ⚠ 이 페이지는 <strong>https://</strong>로 호스팅해야 합니다. (file:// 에서는 OAuth 동작 안 함)
      </div>
    </div>

    <!-- C열 업로드 -->
    <section class="panel">
      <h2>C열 업로드</h2>
      <small>엑셀 헤더(#{강의명}/#{강좌명}) 바로 아래 행 값 → 시트 C열</small>
      <div class="row">
        <input type="file" id="file-c" multiple accept=".xlsx" />
        <button type="button" id="btn-c" onclick="uploadColumn('C')" disabled>C열 업로드</button>
      </div>
      <div id="status-C" class="status info"></div>
    </section>

    <!-- H열 업로드 -->
    <section class="panel">
      <h2>H열 업로드</h2>
      <small>엑셀 헤더(#{강의명}/#{강좌명}) 바로 아래 행 값 → 시트 H열</small>
      <div class="row">
        <input type="file" id="file-h" multiple accept=".xlsx" />
        <button type="button" id="btn-h" onclick="uploadColumn('H')" disabled>H열 업로드</button>
      </div>
      <div id="status-H" class="status info"></div>
    </section>

    <!-- M열 업로드 -->
    <section class="panel">
      <h2>M열 업로드</h2>
      <small>엑셀 헤더(#{강의명}/#{강좌명}) 바로 아래 행 값 → 시트 M열</small>
      <div class="row">
        <input type="file" id="file-m" multiple accept=".xlsx" />
        <button type="button" id="btn-m" onclick="uploadColumn('M')" disabled>M열 업로드</button>
      </div>
      <div id="status-M" class="status info"></div>
    </section>

    <!-- R열 업로드 -->
    <section class="panel">
      <h2>R열 업로드</h2>
      <small>엑셀 헤더(#{강의명}/#{강좌명}) 바로 아래 행 값 → 시트 R열</small>
      <div class="row">
        <input type="file" id="file-r" multiple accept=".xlsx" />
        <button type="button" id="btn-r" onclick="uploadColumn('R')" disabled>R열 업로드</button>
      </div>
      <div id="status-R" class="status info"></div>
    </section>
  </div>

  <script>
    // ========= 1. 설정값 =========
    const CLIENT_ID = '18228268359-iifm4ck3j9kqj74eh1p90tco1k2mbpi0.apps.googleusercontent.com'; // TODO: 본인 OAuth 클라이언트 ID
    const SPREADSHEET_ID = '1APS4O3FRFKVf7nAxkjuVV1JhoA5Rm3mW9pyz6Vkq8NQ'; // TODO: 값 넣을 스프레드시트 ID
    const SHEET_NAME = '시트1';                                          // TODO

    // 업로드 구역 → 실제 시트 열
    const TARGET_COLUMNS = {
      C: 'C',
      H: 'H',
      M: 'M',
      R: 'R',
    };

    // 엑셀 헤더에서 정확히 이 문자열을 찾음
    const HEADER_CANDIDATES = ['#{강의명}', '#{강좌명}'];

    // =============================
    let tokenClient = null;
    let accessToken = null;

    const selectedFiles = { C: [], H: [], M: [], R: [] };

    function setAuthUI(authed) {
      const authBtn = document.getElementById('auth-btn');
      const authStatus = document.getElementById('auth-status');
      const buttons = ['btn-c','btn-h','btn-m','btn-r'].map(id => document.getElementById(id));

      if (authed) {
        authBtn.textContent = '다시 권한 확인하기';
        authStatus.innerHTML = '<span>로그인 완료</span> · 업로드 가능';
        buttons.forEach(b => b.disabled = false);
      } else {
        authBtn.textContent = 'Google 로그인하기';
        authStatus.innerHTML = '<span>로그인 필요</span> · 스프레드시트 편집 권한 허용';
        buttons.forEach(b => b.disabled = true);
      }
    }

    window.addEventListener('load', () => {
      // OAuth 초기화
      tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: 'https://www.googleapis.com/auth/spreadsheets',
        callback: (tokenResponse) => {
          accessToken = tokenResponse.access_token;
          setAuthUI(true);
        },
      });

      document.getElementById('auth-btn').addEventListener('click', () => {
        tokenClient.requestAccessToken({ prompt: accessToken ? '' : 'consent' });
      });

      // 파일 선택 핸들러
      ['C','H','M','R'].forEach(colKey => {
        const input = document.getElementById('file-' + colKey.toLowerCase());
        const statusEl = document.getElementById('status-' + colKey);

        input.addEventListener('change', (e) => {
          const files = Array.from(e.target.files || []);
          if (!files.length) return;

          const store = selectedFiles[colKey];
          files.forEach(f => {
            const exists = store.some(
              x => x.name === f.name && x.size === f.size && x.lastModified === f.lastModified
            );
            if (!exists) store.push(f);
          });

          statusEl.className = 'status info';
          statusEl.textContent =
            `현재 선택된 파일 ${store.length}개:\n` + store.map(f => '- ' + f.name).join('\n');

          input.value = '';
        });
      });

      setAuthUI(false);
    });

    // ========= 2. 엑셀에서 "헤더 바로 아래 행" 값 읽기 =========
    /**
     * 엑셀 전체를 훑어서:
     * - 셀 값이 #{강의명} / #{강좌명}인 위치를 찾고
     * - 그 바로 아래 행의 같은 열 값을 반환
     *
     * 결과: { value, headerText, columnIndex, headerRowIndex } 또는 { error }
     */
    async function readHeaderBelowRowFromFile(file) {
      return new Promise((resolve) => {
        const reader = new FileReader();
        reader.onerror = () => resolve({ error: '파일 읽기 실패' });

        reader.onload = (e) => {
          try {
            const data = new Uint8Array(e.target.result);
            const wb = XLSX.read(data, { type: 'array' });
            const firstSheetName = wb.SheetNames[0];
            const sheet = wb.Sheets[firstSheetName];

            const rows = XLSX.utils.sheet_to_json(sheet, {
              header: 1,
              defval: '',
              blankrows: true,
            });

            if (!rows.length) {
              return resolve({ error: '시트에 데이터가 없습니다.' });
            }

            let headerRowIndex = -1;
            let targetIndex = -1;
            let headerText = '';

            // ★ 모든 행/열을 돌면서 헤더 후보를 찾는다
            outer: for (let i = 0; i < rows.length; i++) {
              const row = rows[i] || [];
              for (let j = 0; j < row.length; j++) {
                const raw = row[j];
                if (raw === undefined || raw === null) continue;

                const cellText = String(raw).trim();
                if (HEADER_CANDIDATES.includes(cellText)) {
                  headerRowIndex = i;
                  targetIndex = j;
                  headerText = cellText;
                  break outer;
                }
              }
            }

            if (headerRowIndex === -1) {
              return resolve({ error: '헤더 #{강의명}/#{강좌명}를 찾지 못했습니다.' });
            }

            const dataRowIndex = headerRowIndex + 1;
            if (dataRowIndex >= rows.length) {
              return resolve({ error: '헤더 바로 아래 행(데이터 행)이 없습니다.' });
            }

            const dataRow = rows[dataRowIndex] || [];
            const value = dataRow[targetIndex] !== undefined ? String(dataRow[targetIndex]) : '';

            resolve({
              value,
              headerText,
              columnIndex: targetIndex,
              headerRowIndex,
            });
          } catch (err) {
            resolve({ error: '엑셀 파싱 실패: ' + err.message });
          }
        };

        reader.readAsArrayBuffer(file);
      });
    }

    // ========= 3. C/H/M/R 열로 업로드 =========
    async function uploadColumn(colKey) {
      const statusEl = document.getElementById('status-' + colKey);
      const files = selectedFiles[colKey] || [];
      const physicalCol = TARGET_COLUMNS[colKey];

      if (!accessToken) {
        alert('먼저 상단의 "Google 로그인하기" 버튼으로 로그인해주세요.');
        return;
      }
      if (!files.length) {
        alert(colKey + '열에 넣을 .xlsx 파일을 선택해주세요.');
        return;
      }

      statusEl.className = 'status info';
      statusEl.textContent = `총 ${files.length}개 파일 분석 중...\n(헤더 바로 아래 행 값 미리보기)`;

      const values = [];
      let successCount = 0;
      let emptyCount = 0;
      let failCount = 0;
      const debugLines = [];

      for (const file of files) {
        const result = await readHeaderBelowRowFromFile(file);

        if (result.error) {
          failCount++;
          debugLines.push(`✖ ${file.name} → 오류: ${result.error}`);
          continue;
        }

        const { value, headerText, columnIndex, headerRowIndex } = result;
        const colLetter = indexToColumnLetter(columnIndex);
        const dataRowNumber = headerRowIndex + 2; // 엑셀 기준 1행부터 시작이므로 +1, 거기서 또 +1

        if (value === '') {
          emptyCount++;
          debugLines.push(
            `△ ${file.name} → 헤더 "${headerText}" (${colLetter}${headerRowIndex+1}) 바로 아래 셀 ${colLetter}${dataRowNumber} 값이 비어 있습니다.`
          );
        } else {
          successCount++;
          debugLines.push(
            `○ ${file.name} → 헤더 "${headerText}" (${colLetter}${headerRowIndex+1}) 아래 ${colLetter}${dataRowNumber}: "${value}"`
          );
        }

        values.push([value]); // 공백이어도 줄 수는 맞춰서 넣음
      }

      statusEl.textContent =
        `분석 결과 (미리보기):\n` +
        debugLines.join('\n') +
        `\n\n읽어온 파일: ${files.length}개 (성공 ${successCount}, 공백 ${emptyCount}, 실패 ${failCount})`;

      if (!values.length) {
        statusEl.className = 'status err';
        statusEl.textContent += '\n\n→ 읽어 온 값이 하나도 없어 시트에는 아무 것도 쓰지 않았습니다.';
        return;
      }

      const allEmpty = values.every(row => row[0] === '');
      if (allEmpty) {
        statusEl.className = 'status err';
        statusEl.textContent += '\n\n→ 모든 파일에서 값이 공백이라 시트에는 쓰지 않았습니다.';
        return;
      }

      try {
        // 이 열에서 헤더 제외(2행부터) 이미 몇 개 있는지 확인
        const colRange = `${SHEET_NAME}!${physicalCol}2:${physicalCol}`;
        const getUrl = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${encodeURIComponent(colRange)}`;

        const resGet = await fetch(getUrl, {
          method: 'GET',
          headers: { 'Authorization': `Bearer ${accessToken}` },
        });

        let existingCount = 0;
        if (resGet.ok) {
          const data = await resGet.json();
          existingCount = (data.values || []).length;
        } else if (resGet.status !== 404) {
          const text = await resGet.text();
          console.warn('열 값 읽기 오류:', text);
        }

        const startRow = 2 + existingCount;
        const endRow   = startRow + values.length - 1;
        const updateRange = `${SHEET_NAME}!${physicalCol}${startRow}:${physicalCol}${endRow}`;
        const putUrl = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${encodeURIComponent(updateRange)}?valueInputOption=RAW`;

        const resUpdate = await fetch(putUrl, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${accessToken}`,
            'Content-Type': 'application/json; charset=utf-8',
          },
          body: JSON.stringify({ values }),
        });

        if (!resUpdate.ok) {
          const text = await resUpdate.text();
          throw new Error('Sheets API update 오류: ' + text);
        }

        statusEl.className = 'status ok';
        statusEl.textContent +=
          `\n\n실제 쓰여진 범위: ${updateRange}\n` +
          `→ ${colKey}열 업로드 완료 (성공 ${successCount}, 공백 ${emptyCount}, 실패 ${failCount})`;

        selectedFiles[colKey] = [];
      } catch (err) {
        console.error(err);
        statusEl.className = 'status err';
        statusEl.textContent += '\n\n시트 업로드 중 오류: ' + err.message;
      }
    }

    // 0-based index → 열 문자(A/B/C...)
    function indexToColumnLetter(index) {
      let result = '';
      let n = index;
      while (n >= 0) {
        result = String.fromCharCode((n % 26) + 65) + result;
        n = Math.floor(n / 26) - 1;
      }
      return result;
    }
  </script>
</body>
</html>

