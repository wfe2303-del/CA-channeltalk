<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>D3 â†’ í—¤ë”(ê°•ì˜ëª…/ê°•ì¢Œëª…) ì—´ ì—…ë¡œë“œ ë„êµ¬</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <!-- Google Identity Services (OAuth í† í°ìš©) -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <!-- XLSX íŒŒì„œ (ë¸Œë¼ìš°ì €ì—ì„œ .xlsx ì½ê¸°ìš©) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    :root {
      --bg: #f8fafc;
      --card: #ffffff;
      --border: #e5e7eb;
      --accent: #2563eb;
      --accent-soft: #dbeafe;
      --danger: #ef4444;
      --ok: #22c55e;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background: var(--bg);
      color: #0f172a;
    }
    .app {
      max-width: 960px;
      margin: 0 auto;
      padding: 16px;
    }
    header {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 16px;
    }
    header h1 {
      font-size: 1.25rem;
      margin: 0;
    }
    .sub {
      font-size: 0.85rem;
      color: #64748b;
    }
    button {
      cursor: pointer;
      border-radius: 999px;
      border: 1px solid transparent;
      padding: 8px 16px;
      font-size: 0.9rem;
      font-weight: 500;
      background: var(--accent);
      color: white;
      transition: background 0.15s ease, transform 0.05s ease;
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    button:hover:not(:disabled) {
      background: #1d4ed8;
      transform: translateY(-1px);
    }
    .panel {
      background: var(--card);
      border-radius: 12px;
      border: 1px solid var(--border);
      padding: 16px 16px 12px;
      margin-bottom: 12px;
    }
    .panel h2 {
      font-size: 1rem;
      margin: 0 0 4px;
    }
    .panel small {
      font-size: 0.8rem;
      color: #64748b;
    }
    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 8px;
      align-items: center;
    }
    input[type="file"] {
      font-size: 0.85rem;
    }
    .status {
      font-size: 0.8rem;
      margin-top: 6px;
      min-height: 1.1em;
    }
    .status.ok { color: var(--ok); }
    .status.err { color: var(--danger); }
    .status.info { color: #64748b; }
    .auth-status {
      font-size: 0.85rem;
    }
    .auth-status span {
      font-weight: 600;
    }
    .pill {
      display: inline-flex;
      padding: 4px 8px;
      border-radius: 999px;
      font-size: 0.78rem;
      background: #fee2e2;
      color: #b91c1c;
      margin-top: 4px;
    }
    @media (max-width: 600px) {
      header { align-items: flex-start; }
      .row { flex-direction: column; align-items: flex-start; }
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div>
        <h1>.xlsx D3 â†’ í—¤ë”(ê°•ì˜ëª…/ê°•ì¢Œëª…) ì—´ ì—…ë¡œë“œ</h1>
        <div class="sub">
          ê° ì—‘ì…€ íŒŒì¼ì˜ <strong>D3</strong> ê°’ì„ ì½ì–´ì„œ,<br/>
          ì…ë ¥ ì‹œíŠ¸ì˜ 1í–‰ì—ì„œ <strong>â€œê°•ì˜ëª…â€ ë˜ëŠ” â€œê°•ì¢Œëª…â€</strong> ì´ë¼ê³  ì íŒ í—¤ë” ì—´ì„ ì°¾ì•„<br/>
          ê·¸ ì—´ì˜ <strong>2í–‰ë¶€í„°</strong> ì•„ë˜ë¡œ ì°¨ë¡€ëŒ€ë¡œ ì±„ì›ë‹ˆë‹¤.<br/>
          ğŸ‘‰ ë‹¤ë¥¸ ì—´/í–‰ì€ ì „í˜€ ê±´ë“œë¦¬ì§€ ì•ŠìŠµë‹ˆë‹¤.
        </div>
      </div>
      <div style="text-align:right;">
        <button id="auth-btn" type="button">Google ë¡œê·¸ì¸í•˜ê¸°</button>
        <div id="auth-status" class="auth-status">
          <span>ë¡œê·¸ì¸ í•„ìš”</span> Â· ìŠ¤í”„ë ˆë“œì‹œíŠ¸ í¸ì§‘ ê¶Œí•œ í—ˆìš©
        </div>
      </div>
    </header>

    <div class="panel">
      <div class="pill">ì£¼ì˜: ì´ í˜ì´ì§€ëŠ” https://(ë„ë©”ì¸)/ í˜•íƒœë¡œ í˜¸ìŠ¤íŒ…ë˜ì–´ì•¼ í•©ë‹ˆë‹¤. file:// ë¡œëŠ” OAuthê°€ ì•ˆ ë©ë‹ˆë‹¤.</div>
    </div>

    <!-- C êµ¬ì—­ -->
    <section class="panel">
      <h2>ì—…ë¡œë“œ êµ¬ì—­ C</h2>
      <small>D3 â†’ â€œê°•ì˜ëª…/ê°•ì¢Œëª…â€ í—¤ë” ì—´ (2í–‰ë¶€í„°) Â· ì—¬ëŸ¬ íŒŒì¼ ëˆ„ì  ê°€ëŠ¥</small>
      <div class="row">
        <input type="file" id="file-c" multiple accept=".xlsx" />
        <button type="button" id="btn-c" onclick="uploadColumn('C')" disabled>ì—…ë¡œë“œ(C)</button>
      </div>
      <div id="status-C" class="status info"></div>
    </section>

    <!-- H êµ¬ì—­ -->
    <section class="panel">
      <h2>ì—…ë¡œë“œ êµ¬ì—­ H</h2>
      <small>D3 â†’ â€œê°•ì˜ëª…/ê°•ì¢Œëª…â€ í—¤ë” ì—´ (2í–‰ë¶€í„°)</small>
      <div class="row">
        <input type="file" id="file-h" multiple accept=".xlsx" />
        <button type="button" id="btn-h" onclick="uploadColumn('H')" disabled>ì—…ë¡œë“œ(H)</button>
      </div>
      <div id="status-H" class="status info"></div>
    </section>

    <!-- M êµ¬ì—­ -->
    <section class="panel">
      <h2>ì—…ë¡œë“œ êµ¬ì—­ M</h2>
      <small>D3 â†’ â€œê°•ì˜ëª…/ê°•ì¢Œëª…â€ í—¤ë” ì—´ (2í–‰ë¶€í„°)</small>
      <div class="row">
        <input type="file" id="file-m" multiple accept=".xlsx" />
        <button type="button" id="btn-m" onclick="uploadColumn('M')" disabled>ì—…ë¡œë“œ(M)</button>
      </div>
      <div id="status-M" class="status info"></div>
    </section>

    <!-- R êµ¬ì—­ -->
    <section class="panel">
      <h2>ì—…ë¡œë“œ êµ¬ì—­ R</h2>
      <small>D3 â†’ â€œê°•ì˜ëª…/ê°•ì¢Œëª…â€ í—¤ë” ì—´ (2í–‰ë¶€í„°)</small>
      <div class="row">
        <input type="file" id="file-r" multiple accept=".xlsx" />
        <button type="button" id="btn-r" onclick="uploadColumn('R')" disabled>ì—…ë¡œë“œ(R)</button>
      </div>
      <div id="status-R" class="status info"></div>
    </section>
  </div>

  <script>
    // === 1. ê¸°ë³¸ ì„¤ì • ==========================================
    const CLIENT_ID = '18228268359-iifm4ck3j9kqj74eh1p90tco1k2mbpi0.apps.googleusercontent.com'; // TODO: ë³¸ì¸ OAuth í´ë¼ì´ì–¸íŠ¸ ID
    const SPREADSHEET_ID = '1APS4O3FRFKVf7nAxkjuVV1JhoA5Rm3mW9pyz6Vkq8NQ'; // TODO: ê°’ ë„£ì„ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ID
    const SHEET_NAME = 'ì‹œíŠ¸1';                                          // TODO: ì‹œíŠ¸ íƒ­ ì´ë¦„

    /**
     * ê° ì—…ë¡œë“œ êµ¬ì—­(C/H/M/R)ì´ ì–´ë–¤ í—¤ë”ëª…ì„ ê°€ì§„ ì—´ì„ ì“¸ì§€ ì •ì˜
     * - ê¸°ë³¸ì€ ëª¨ë‘ "ê°•ì˜ëª…" / "ê°•ì¢Œëª…" ì—´ì„ ì‚¬ìš©
     *   í•„ìš”í•˜ë©´ ê° í‚¤ë³„ë¡œ ë‹¤ë¥¸ í—¤ë”ëª… ë°°ì—´ë¡œ ë°”ê¿”ë„ ë¨.
     */
    const COLUMN_HEADERS = {
      C: ['ê°•ì˜ëª…', 'ê°•ì¢Œëª…'],
      H: ['ê°•ì˜ëª…', 'ê°•ì¢Œëª…'],
      M: ['ê°•ì˜ëª…', 'ê°•ì¢Œëª…'],
      R: ['ê°•ì˜ëª…', 'ê°•ì¢Œëª…'],
    };

    let tokenClient = null;
    let accessToken = null;

    // ì—´ë³„ë¡œ ì„ íƒëœ íŒŒì¼ ëˆ„ì  ì €ì¥ìš©
    const selectedFiles = { C: [], H: [], M: [], R: [] };

    function setAuthUI(authed) {
      const authBtn = document.getElementById('auth-btn');
      const authStatus = document.getElementById('auth-status');
      const buttons = ['btn-c','btn-h','btn-m','btn-r'].map(id => document.getElementById(id));

      if (authed) {
        authBtn.textContent = 'ë‹¤ì‹œ ê¶Œí•œ í™•ì¸í•˜ê¸°';
        authStatus.innerHTML = '<span>ë¡œê·¸ì¸ ì™„ë£Œ</span> Â· ì—…ë¡œë“œ ê°€ëŠ¥';
        buttons.forEach(b => b.disabled = false);
      } else {
        authBtn.textContent = 'Google ë¡œê·¸ì¸í•˜ê¸°';
        authStatus.innerHTML = '<span>ë¡œê·¸ì¸ í•„ìš”</span> Â· ìŠ¤í”„ë ˆë“œì‹œíŠ¸ í¸ì§‘ ê¶Œí•œ í—ˆìš©';
        buttons.forEach(b => b.disabled = true);
      }
    }

    function initTokenClientIfNeeded() {
      try {
        if (tokenClient) return;
        if (typeof google === 'undefined' || !google.accounts || !google.accounts.oauth2) {
          console.warn('Google OAuth ì´ˆê¸°í™” ëŒ€ê¸° ì¤‘ (google ê°ì²´ ì—†ìŒ)');
          return;
        }
        tokenClient = google.accounts.oauth2.initTokenClient({
          client_id: CLIENT_ID,
          scope: 'https://www.googleapis.com/auth/spreadsheets',
          callback: (tokenResponse) => {
            accessToken = tokenResponse.access_token;
            setAuthUI(true);
          },
        });
        console.log('TokenClient ì´ˆê¸°í™” ì™„ë£Œ');
      } catch (e) {
        console.error('initTokenClientIfNeeded ì—ëŸ¬', e);
      }
    }

    window.addEventListener('load', () => {
      // íŒŒì¼ ì„ íƒ ì‹œ ì—´ë³„ íŒŒì¼ ëˆ„ì 
      ['C','H','M','R'].forEach(col => {
        const lower = col.toLowerCase();
        const input = document.getElementById('file-' + lower);
        const statusEl = document.getElementById('status-' + col);

        input.addEventListener('change', (e) => {
          const files = Array.from(e.target.files || []);
          if (!files.length) return;

          const store = selectedFiles[col];

          files.forEach(f => {
            const exists = store.some(
              x => x.name === f.name && x.size === f.size && x.lastModified === f.lastModified
            );
            if (!exists) store.push(f);
          });

          statusEl.className = 'status info';
          statusEl.textContent =
            `í˜„ì¬ ì„ íƒëœ íŒŒì¼ ${store.length}ê°œ: ` + store.map(f => f.name).join(', ');

          input.value = ''; // ê°™ì€ íŒŒì¼ ë‹¤ì‹œ ì„ íƒ ê°€ëŠ¥í•˜ê²Œ ì´ˆê¸°í™”
        });
      });

      // ë¡œê·¸ì¸ ë²„íŠ¼
      const authBtn = document.getElementById('auth-btn');
      authBtn.addEventListener('click', () => {
        initTokenClientIfNeeded();
        if (!tokenClient) {
          alert('Google ë¡œê·¸ì¸ ì´ˆê¸°í™” ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
          return;
        }
        tokenClient.requestAccessToken({ prompt: accessToken ? '' : 'consent' });
      });

      setAuthUI(false);
    });

    // === 2. .xlsxì—ì„œ D3 ì½ê¸° =========================================
    function readD3FromFile(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onerror = () => reject(new Error('íŒŒì¼ ì½ê¸° ì‹¤íŒ¨: ' + file.name));
        reader.onload = (e) => {
          try {
            const data = new Uint8Array(e.target.result);
            const wb = XLSX.read(data, { type: 'array' });
            const firstSheetName = wb.SheetNames[0];
            const sheet = wb.Sheets[firstSheetName];
            const cell = sheet['D3'];
            const value = cell ? String(cell.v) : '';
            resolve(value);
          } catch (err) {
            reject(new Error('ì—‘ì…€ íŒŒì‹± ì‹¤íŒ¨: ' + file.name + ' Â· ' + err.message));
          }
        };
        reader.readAsArrayBuffer(file);
      });
    }

    // === 3. í—¤ë”ëª…ìœ¼ë¡œ ì—´ ì°¾ê¸° =========================================

    // 0-based index â†’ A/B/C... ë¡œ ë³€í™˜
    function indexToColumnLetter(index) {
      let result = '';
      let n = index;
      while (n >= 0) {
        result = String.fromCharCode((n % 26) + 65) + result;
        n = Math.floor(n / 26) - 1;
      }
      return result;
    }

    /**
     * headerNames ì¤‘ í•˜ë‚˜ì™€ ì¼ì¹˜í•˜ëŠ” í—¤ë”ë¥¼ 1í–‰ì—ì„œ ì°¾ê³ ,
     * ê·¸ ì—´ì˜ "ì—´ ë¬¸ì" (ì˜ˆ: C, H, AA...)ë¥¼ ë¦¬í„´
     */
    async function findColumnByHeader(headerNames) {
      if (!headerNames || headerNames.length === 0) {
        throw new Error('ì°¾ì„ í—¤ë”ëª…ì´ ì„¤ì •ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤.');
      }

      const range = `${SHEET_NAME}!1:1`;
      const url = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${encodeURIComponent(range)}`;

      const res = await fetch(url, {
        method: 'GET',
        headers: { 'Authorization': `Bearer ${accessToken}` },
      });

      if (!res.ok) {
        const text = await res.text();
        throw new Error('í—¤ë” í–‰ ì½ê¸° ì˜¤ë¥˜: ' + text);
      }

      const data = await res.json();
      const headerRow = (data.values && data.values[0]) || [];

      const trimmedTargets = headerNames.map(h => String(h).trim());

      let foundIndex = -1;
      for (let i = 0; i < headerRow.length; i++) {
        const cellText = String(headerRow[i]).trim();
        if (trimmedTargets.includes(cellText)) {
          foundIndex = i;
          break;
        }
      }

      if (foundIndex === -1) {
        throw new Error(
          `1í–‰ì—ì„œ ì§€ì •í•œ í—¤ë”(${headerNames.join(' / ')})ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`
        );
      }

      return indexToColumnLetter(foundIndex); // ì˜ˆ: 2 â†’ C
    }

    // === 4. ì—…ë¡œë“œ (í–‰ ì•ˆ ë°€ë¦¬ê³ , í—¤ë” ì—´ë§Œ ì”€) =======================
    async function uploadColumn(colKey) {
      const statusEl = document.getElementById('status-' + colKey);
      const files = selectedFiles[colKey] || [];
      const headerCandidates = COLUMN_HEADERS[colKey] || [];

      if (!accessToken) {
        alert('ë¨¼ì € ìƒë‹¨ì˜ "Google ë¡œê·¸ì¸í•˜ê¸°" ë²„íŠ¼ìœ¼ë¡œ ë¡œê·¸ì¸ì„ í•´ì£¼ì„¸ìš”.');
        return;
      }

      if (!files.length) {
        alert(colKey + ' êµ¬ì—­ì— ë„£ì„ .xlsx íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
      }

      statusEl.className = 'status info';
      statusEl.textContent = `ì´ ${files.length}ê°œ íŒŒì¼ì—ì„œ D3 ê°’ì„ ì½ëŠ” ì¤‘...`;

      // 1) íŒŒì¼ë§ˆë‹¤ D3 ì½ê¸°
      const values = [];
      let successCount = 0;
      let emptyCount = 0;
      let failCount = 0;

      for (const file of files) {
        try {
          const v = await readD3FromFile(file);
          if (v === '') emptyCount++;
          values.push([v]);
          successCount++;
        } catch (err) {
          console.error(err);
          failCount++;
        }
      }

      if (!values.length) {
        statusEl.className = 'status err';
        statusEl.textContent = 'ì½ì–´ ì˜¨ ê°’ì´ ì—†ìŠµë‹ˆë‹¤.';
        return;
      }

      try {
        // 2) í—¤ë”ëª…ìœ¼ë¡œ ì‹¤ì œ ì—´ ë¬¸ì ì°¾ê¸°
        const physicalCol = await findColumnByHeader(headerCandidates);

        // 3) ê·¸ ì—´ì—ì„œ ì´ë¯¸ ì±„ì›Œì§„ í–‰ ìˆ˜ í™•ì¸ (2í–‰ë¶€í„°)
        const colRange = `${SHEET_NAME}!${physicalCol}2:${physicalCol}`;
        const getUrl = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${encodeURIComponent(colRange)}`;

        const resGet = await fetch(getUrl, {
          method: 'GET',
          headers: { 'Authorization': `Bearer ${accessToken}` },
        });

        let existingCount = 0;
        if (resGet.ok) {
          const data = await resGet.json();
          existingCount = (data.values || []).length;
        } else if (resGet.status !== 404) {
          const text = await resGet.text();
          console.warn('col get error:', text);
        }

        const startRow = 2 + existingCount;
        const endRow = startRow + values.length - 1;
        const updateRange = `${SHEET_NAME}!${physicalCol}${startRow}:${physicalCol}${endRow}`;

        const putUrl = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${encodeURIComponent(updateRange)}?valueInputOption=RAW`;

        const resUpdate = await fetch(putUrl, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${accessToken}`,
            'Content-Type': 'application/json; charset=utf-8',
          },
          body: JSON.stringify({ values }),
        });

        if (!resUpdate.ok) {
          const text = await resUpdate.text();
          throw new Error('Sheets API update ì˜¤ë¥˜: ' + text);
        }

        statusEl.className = 'status ok';
        statusEl.textContent =
          `${colKey} ì—…ë¡œë“œ ì™„ë£Œ Â· (í—¤ë”: ${headerCandidates.join('/')})`
          + ` Â· ì„±ê³µ ${successCount}ê°œ, D3 ë¹„ì–´ìˆìŒ ${emptyCount}ê°œ, ì‹¤íŒ¨ ${failCount}ê°œ`;

        selectedFiles[colKey] = []; // ì„ íƒ íŒŒì¼ ì´ˆê¸°í™”
      } catch (err) {
        console.error(err);
        statusEl.className = 'status err';
        statusEl.textContent = 'ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜: ' + err.message;
      }
    }
  </script>
</body>
</html>
